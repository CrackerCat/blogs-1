# 反思｜Android 输入系统 & ANR机制的设计与实现

## 概述

对于`Android`开发者而言，`ANR`是一个老生常谈的问题，站在面试者的角度，似乎说出 **「不要在主线程做耗时操作」** 就算合格了。

但是，`ANR`机制到底是什么，其背后的原理究竟如何，为什么要设计出这样的机制？这些问题时时刻刻会萦绕脑海，而想搞清楚这些，就不得不提到`Android`自身的 **输入系统** （`Input System`）。

`Android`自身的 **输入系统** 究竟是什么？一言以蔽之，任何与`Android`设备的交互都需要通过其进行管理和分发；其中最靠近上层，并且开发者最熟悉的一个小环节就是`View`的 **事件分发** 流程。

> 对于事件分发机制的分析，可以参考笔者的这两篇文章：
> * [Android 事件分发机制的设计与实现](https://juejin.im/post/6844903926446161927)
> * [Android 事件拦截机制的设计与实现](https://juejin.im/post/6844904128397705230)

这样看来，**输入系统** 本身确实是一个非常庞大复杂的命题，并且，越靠近底层细节，越容易有一种 **只见树木不见树林** 之感，反复几次，直至迷失在细节代码的较真中，一次学习的努力尝试付诸东流。

因此，**控制住原理分析的粒度，在宏观的角度，系统地了解输入系统本身的设计理念，并引申到实际开发中的`ANR`现象的原理和解决思路** ，是一个非常不错的理论与实践相结合的学习方式，这也正是笔者写作本文的初衷。

本文篇幅较长，整体思维导图如下：

// TODO

## 亚当与夏娃

谈到`Android`系统本身，首先，必须将 **应用进程** 和 **系统进程** 有一个清晰的认知，前者一般代表开发者依托`Android`平台本身创造开发的应用；后者则代表 `Android`系统自身创建的核心进程。

这里我们抛开 **应用进程** ，先将视线转向 **系统进程**，因为 **输入系统** 本身是由后者初始化和管理调度的。

`Android`系统在启动的时候,会初始化`zygote`进程和由`zygote`进程`fork`出来的`SystemServer`进程；作为 **系统进程** 之一，`SystemServer`进程会提供一系列的系统服务，而接下来要讲到的`InputManagerService`也正是由 `SystemServer` 提供的。
