# WorkManager 设计与实现

## 现状

作为一名 `Android` 开发者，即使你没有用过，也一定对 `WorkManager` 耳熟能详。

自2018年发布以来，作为 `Google` 官方推出的架构组件，它并未像 `LiveData`、`ViewModel` 一样得到广泛应用。究其原因，一起来看 **官方** 当初对 `WorkManager` 的描述：

> **`WorkManager`** 用于执行可 **延迟**、**异步** 的后台任务。它提供了一个 **可靠**、**可调度** 的后台任务执行环境，可以处理 **即使在应用退出或设备重启后仍需要运行** 的任务。

快速提炼重点，你得到了什么?

> `WorkManager`，可以处理后台任务，这些任务哪怕手机重启也一定会执行?

看完简介，我的内心毫无波澜，"关机重启仍会执行" 的确很不错，but who cares ? 我根本用不到这些。

——它给人的第一印象并不惊艳，甚至可以说 **平平无奇** ，无论是相亲市场，还是技术领域，这都非常致命。

时至今日，社区内除了若干 **使用简介** 和 **源码分析** 的博客单篇，我们仍无法找到其 **实战进阶** 或 **最佳实践** 的相关系列。

---

经过一系列的实践和研究后，回过头再看 `WorkManager`，它究竟被用来解决什么问题？

**后台任务的处理和调度**。

实际上，我认为 `WorkManager` 和 `Paging` 一样，是传统 `Android` 领域内学院派编程风格的代表作，是沧海遗珠——它和 `Paging` 面临着同样困境，难以推广、默默无闻：简单的项目用不到，复杂的项目经过若干年的沉淀，该领域早已应用了其它方案，学习和迁移成本过高，以至不被需要。

精兵如炬，困龙难飞。

本文笔者将通过针对 `Android` 的后台任务管理机制，进行一个系统性的分析和设计。

最终的目的，并非是让读者将 `WorkManager` 强行引入和使用，而是对 **后台任务的管理和调度** 有一个清晰的认知——即使从未使用过，在将来的某一天，遇到类似的业务诉求时，也能快速形成一个清晰的思路和方案。

## 一、成长记

构建一个优秀的后台任务的管理和调度工具库（下文简称 **后台任务库** ），是依靠不断的迭代，以支持越来越多的应用场景，最终成为一个灵活、强大、完善的工具。

那么，一个完善的 **后台任务库** 需要提供哪些功能，为什么要设计这些功能？

举个例子，你负责的是一个视频类`APP`的研发，最初的业务诉求如下：

> 1. `APP` 后台不断向服务端进行数据 (`Log`) 上报，仅需不断创建异步操作，进行本地`Log`文件的 `IO`操作和文件上传即可。

## 首先要了解2个最基本的概念：**任务队列** 和 **线程调度**。
